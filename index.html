<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotebookLM ç°¡å ±å·¥å…·ç®± - AI é€†å‘å·¥ç¨‹</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF.js æ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- JSZip & FileSaver (for PPTX merge) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        /* Tab åˆ‡æ›æ•ˆæœ */
        .tab-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn.active {
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }

        /* æ‹–æ”¾å€åŸŸ */
        .drop-zone {
            transition: all 0.3s ease;
            border: 2px dashed rgba(100, 116, 139, 0.5);
        }

        .drop-zone:hover,
        .drop-zone.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
            transform: scale(1.01);
        }

        /* Loader å‹•ç•« */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* PDF é é¢ç¶²æ ¼ */
        .pdf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        /* ç»ç’ƒæ…‹å¡ç‰‡ */
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        /* æ¼¸è®ŠæŒ‰éˆ• */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            transform: none;
            cursor: not-allowed;
        }

        /* æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Slot å¡ç‰‡ */
        .slot-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slot-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* é é¢å¡ç‰‡ */
        .page-card {
            transition: all 0.2s ease;
        }

        .page-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        /* å·¥å…·å€å¡Šéš±è—/é¡¯ç¤º */
        .tool-section {
            display: none;
        }

        .tool-section.active {
            display: block;
        }
    </style>
</head>

<body class="text-slate-100 pb-20">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-card border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-black tracking-tight">
                        <span
                            class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">NotebookLM</span>
                        <span class="text-slate-300">ç°¡å ±å·¥å…·ç®±</span>
                    </h1>
                    <p class="text-slate-500 text-sm font-medium mt-1">AI é€†å‘å·¥ç¨‹ Â· PDF è½‰ PPTX Â· æ™ºæ…§å»å­—</p>
                </div>

                <!-- Tab å°èˆª -->
                <nav class="flex items-center gap-2">
                    <div class="flex gap-2 bg-slate-800/50 p-1 rounded-xl">
                        <button id="tab-pdf"
                            class="tab-btn active px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            PDF è§£æ & å»å­—
                        </button>
                        <button id="tab-merge"
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 text-slate-400 hover:text-slate-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            PPTX åˆä½µ
                        </button>
                    </div>
                    <button id="settings-btn"
                        class="p-2 text-slate-400 hover:text-white transition rounded-xl hover:bg-slate-700/50"
                        title="API Key è¨­å®š">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- ==================== å·¥å…· 1: PDF è§£æ & å»å­— ==================== -->
        <section id="section-pdf" class="tool-section active space-y-8">

            <!-- PDF ä¸Šå‚³å€ -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div
                        class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center font-black text-sm">
                        1</div>
                    <h2 class="text-lg font-bold text-slate-200">PDF é«˜ç²¾ç´°è§£æ</h2>
                </div>

                <div id="pdf-drop-zone" class="drop-zone rounded-2xl p-12 text-center cursor-pointer">
                    <input type="file" id="pdf-file-input" class="hidden" accept="application/pdf">

                    <div id="pdf-empty-state">
                        <div
                            class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                        <p class="text-xl font-bold text-slate-300">é»æ“Šæˆ–æ‹–æ”¾ PDF é€²è¡Œè§£æ</p>
                        <p class="text-slate-500 text-sm mt-2">ç³»çµ±å°‡è‡ªå‹•æå–æ–‡å­—å…§å®¹èˆ‡æ’ç‰ˆï¼Œæ”¯æ´ä¸€éµå°å‡º PPTX</p>
                    </div>

                    <div id="pdf-preview-container" class="hidden text-left">
                        <div class="flex items-center justify-between bg-slate-800/50 p-4 rounded-xl mb-4">
                            <div class="flex items-center gap-3">
                                <span id="page-count-tag"
                                    class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">0
                                    PAGES</span>
                                <span class="text-xs font-bold text-slate-500">READY FOR ANALYSIS</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="pdf-to-pptx-btn"
                                    class="btn-primary text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2">
                                    <span id="pptx-btn-text">è¦–è¦ºé‚„åŸ PPTX</span>
                                    <div id="pptx-loader" class="loader !w-3 !h-3 hidden"></div>
                                </button>
                                <button id="add-all-pages-btn"
                                    class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-xl text-xs font-bold">ä¸€éµå°å…¥å»å­—</button>
                                <button id="clear-pdf-btn"
                                    class="text-xs font-bold text-red-400 px-3 hover:underline">æ¸…é™¤</button>
                            </div>
                        </div>
                        <div id="pdf-pages-list" class="pdf-grid"></div>
                    </div>
                </div>
            </div>

            <!-- åœ–ç‰‡å»å­—å·¥ä½œå° -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 bg-purple-600 text-white rounded-lg flex items-center justify-center font-black text-sm">
                            2</div>
                        <h2 class="text-lg font-bold text-slate-200">åœ–ç‰‡å»æ–‡å­—å·¥ä½œå°</h2>
                    </div>

                    <div class="flex items-center gap-3 flex-wrap">
                        <div id="result-export-group"
                            class="hidden flex items-center gap-3 bg-slate-800/50 px-3 py-2 rounded-xl">
                            <select id="work-ratio-select"
                                class="text-xs font-bold border-none bg-transparent outline-none cursor-pointer text-blue-400">
                                <option value="16:9">16:9</option>
                                <option value="9:16">9:16</option>
                                <option value="4:3">4:3</option>
                            </select>
                            <button id="export-results-pptx-btn"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold">å°å‡ºçµæœ
                                PPTX</button>
                        </div>

                        <select id="slot-count-select"
                            class="hidden bg-slate-800 text-slate-300 text-xs font-bold px-3 py-2 rounded-xl border border-slate-700">
                            <option value="4">4 æ§½ä½</option>
                            <option value="8">8 æ§½ä½</option>
                            <option value="12">12 æ§½ä½</option>
                        </select>

                        <button id="clear-all-slots-btn"
                            class="hidden text-xs font-bold text-red-400 hover:underline">å…¨éƒ¨æ¸…é™¤</button>
                        <button id="process-all-btn"
                            class="btn-primary hidden text-white px-4 py-2 rounded-xl text-xs font-bold">é–‹å§‹æ‰¹æ¬¡å»å­—</button>
                    </div>
                </div>

                <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
                <div id="master-drop-zone" class="drop-zone rounded-xl p-6 text-center cursor-pointer mb-6">
                    <input type="file" id="master-file-input" class="hidden" accept="image/*" multiple>
                    <p class="text-slate-400 font-medium">åœ¨æ­¤ä¸Šå‚³åœ–ç‰‡ã€å¾ä¸Šæ–¹ PDF æ‹–æ›³ï¼Œæˆ–é»æ“Šé é¢ã€Œï¼‹ã€å°å…¥</p>
                </div>

                <!-- æ§½ä½å®¹å™¨ -->
                <div id="slots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <!-- ==================== å·¥å…· 2: PPTX åˆä½µ ==================== -->
        <section id="section-merge" class="tool-section">
            <div class="glass-card rounded-2xl p-8">
                <div class="text-center mb-8">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-black text-slate-200">PPTX é­”æ³•åˆä½µå·¥å…·</h2>
                    <p class="text-slate-500 mt-2">å°‡æ–‡å­—å…§å®¹ç§»æ¤åˆ°èƒŒæ™¯æ¨¡æ¿ï¼Œå¯¦ç¾å®Œç¾åˆä½µ</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center mb-8">
                    <!-- æ–‡å­—æª”ä¸Šå‚³ -->
                    <div id="merge-text-zone"
                        class="drop-zone rounded-2xl p-6 text-center cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <input type="file" id="merge-text-input" class="hidden" accept=".pptx">
                        <div id="merge-text-empty">
                            <svg class="w-10 h-10 text-slate-500 mx-auto mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <p class="font-bold text-slate-300 text-sm">1. ä¸Šå‚³æ–‡å­—æª” (ç„¡èƒŒæ™¯)</p>
                            <p class="text-xs text-slate-500 mt-1">é»æ“Šæˆ–æ‹–æ”¾ .pptx</p>
                        </div>
                        <div id="merge-text-filled" class="hidden">
                            <div
                                class="w-12 h-12 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-2">
                                âœ“</div>
                            <p id="merge-text-name" class="font-bold text-slate-300 text-sm break-all"></p>
                        </div>
                    </div>

                    <!-- ç®­é ­ -->
                    <div class="hidden md:flex justify-center">
                        <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>

                    <!-- èƒŒæ™¯æª”ä¸Šå‚³ -->
                    <div id="merge-bg-zone"
                        class="drop-zone rounded-2xl p-6 text-center cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <input type="file" id="merge-bg-input" class="hidden" accept=".pptx">
                        <div id="merge-bg-empty">
                            <svg class="w-10 h-10 text-slate-500 mx-auto mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" stroke-width="2"></rect>
                                <circle cx="9" cy="9" r="2" stroke-width="2"></circle>
                                <path d="m21 15-3.086-3.086a2 2 0 00-2.828 0L6 21" stroke-width="2"></path>
                            </svg>
                            <p class="font-bold text-slate-300 text-sm">2. ä¸Šå‚³èƒŒæ™¯æª” (ç„¡æ–‡å­—)</p>
                            <p class="text-xs text-slate-500 mt-1">é»æ“Šæˆ–æ‹–æ”¾ .pptx</p>
                        </div>
                        <div id="merge-bg-filled" class="hidden">
                            <div
                                class="w-12 h-12 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-2">
                                âœ“</div>
                            <p id="merge-bg-name" class="font-bold text-slate-300 text-sm break-all"></p>
                        </div>
                    </div>
                </div>

                <!-- åˆä½µæ§åˆ¶ -->
                <div id="merge-controls" class="flex flex-col items-center gap-4 pt-6 border-t border-slate-700/50">
                    <button id="merge-start-btn" disabled
                        class="btn-primary text-white px-8 py-3 rounded-xl font-bold text-base flex items-center gap-2">
                        é–‹å§‹åˆä½µ
                    </button>

                    <div id="merge-status" class="hidden text-center">
                        <div id="merge-processing" class="hidden flex items-center gap-2 text-blue-400">
                            <div class="loader"></div>
                            <span class="font-bold">æ­£åœ¨è§£æèˆ‡åˆä½µ XML...</span>
                        </div>
                        <div id="merge-success" class="hidden space-y-3">
                            <div class="flex items-center gap-2 text-emerald-400 font-bold text-lg justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                                åˆä½µæˆåŠŸï¼
                            </div>
                            <div class="flex gap-3 justify-center">
                                <button id="merge-download-btn"
                                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl font-bold text-sm flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    ä¸‹è¼‰æ–°æª”æ¡ˆ
                                </button>
                                <button id="merge-reset-btn"
                                    class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-xl font-bold text-sm">é‡ç½®</button>
                            </div>
                        </div>
                        <div id="merge-error" class="hidden text-red-400 font-bold"></div>
                    </div>
                </div>

                <!-- æ—¥èªŒå€ -->
                <div id="merge-logs"
                    class="mt-6 bg-slate-900/50 rounded-xl p-4 font-mono text-sm max-h-48 overflow-y-auto">
                    <div class="text-slate-500 mb-2 border-b border-slate-700 pb-1">è™•ç†æ—¥èªŒ:</div>
                    <div id="merge-log-content" class="space-y-1">
                        <span class="text-slate-600 italic">ç­‰å¾…æ“ä½œ...</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl opacity-0 transition-all pointer-events-none z-50 font-bold text-sm border border-slate-700">
    </div>
    <!-- API Key Settings Modal -->
    <div id="settings-modal"
        class="fixed inset-0 z-[60] bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center p-4">
        <div
            class="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl overflow-hidden animate-[scaleIn_0.2s_ease-out]">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
                            </path>
                        </svg>
                        API Key è¨­å®š
                    </h3>
                    <button id="close-settings-btn" class="text-slate-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
                        <p class="text-sm text-blue-200">
                            æ‚¨çš„ API Key å°‡æœƒå„²å­˜åœ¨ç€è¦½å™¨çš„
                            <span class="font-bold font-mono bg-blue-500/20 px-1 rounded">localStorage</span>
                            ä¸­ï¼Œä¸æœƒå‚³é€åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
                        </p>
                    </div>

                    <!-- API æ¨¡å¼é¸æ“‡ -->
                    <div class="space-y-2">
                        <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider">API æ¨¡å¼
                            (é€Ÿåº¦æ§åˆ¶)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer relative">
                                <input type="radio" name="api_tier" value="free" class="peer sr-only" checked>
                                <div
                                    class="p-3 rounded-xl bg-slate-900 border border-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition text-center hover:bg-slate-700/50">
                                    <div class="font-bold text-sm text-white">ğŸ¢ å…è²»ç‰ˆ</div>
                                    <div class="text-[10px] text-slate-400 mt-1">ç©©å®šæ…¢é€Ÿ (15 RPM)</div>
                                </div>
                            </label>
                            <label class="cursor-pointer relative">
                                <input type="radio" name="api_tier" value="paid" class="peer sr-only">
                                <div
                                    class="p-3 rounded-xl bg-slate-900 border border-slate-700 peer-checked:border-purple-500 peer-checked:bg-purple-500/10 transition text-center hover:bg-slate-700/50">
                                    <div class="font-bold text-sm text-white">ğŸš€ ä»˜è²»ç‰ˆ</div>
                                    <div class="text-[10px] text-slate-400 mt-1">é«˜é€Ÿä½µç™¼ (Pay-as-you-go)</div>
                                    <a href="https://aistudio.google.com/app/plan_information" target="_blank"
                                        class="text-[9px] text-purple-400 underline mt-1 block hover:text-purple-300">å»ç¶å®šä¿¡ç”¨å¡</a>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Google
                            Gemini API Key</label>
                        <input type="password" id="api-key-input"
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono"
                            placeholder="AIzA...">
                        <p class="text-xs text-slate-500 mt-2 text-right">
                            é‚„æ²’æœ‰ Keyï¼Ÿ<a href="https://aistudio.google.com/app/apikey" target="_blank"
                                class="text-blue-400 hover:text-blue-300 underline">å‰å¾€ç”³è«‹</a>
                        </p>
                    </div>

                    <button id="save-api-key-btn"
                        class="w-full btn-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg hover:shadow-blue-500/25 transition">
                        å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- æ§½ä½æ¨¡æ¿ -->
    <template id="slot-template">
        <div class="slot-card glass-card rounded-2xl p-4 flex flex-col">
            <div
                class="empty-state flex-grow flex flex-col items-center justify-center text-slate-500 italic font-bold text-sm min-h-[280px]">
                <div
                    class="w-10 h-10 border-2 border-dashed border-slate-600 rounded-lg flex items-center justify-center mb-2 text-slate-600">
                    +</div>
                Empty
            </div>
            <div class="active-state hidden flex-grow flex flex-col">
                <div class="flex justify-between mb-3">
                    <span class="text-xs font-bold text-blue-400 slot-label uppercase tracking-widest">SLOT 01</span>
                    <button class="remove-btn text-slate-500 hover:text-red-400 transition font-bold text-lg">Ã—</button>
                </div>
                <div class="space-y-3">
                    <div
                        class="aspect-video bg-slate-800/50 rounded-xl overflow-hidden border border-slate-700 relative">
                        <img class="original-img w-full h-full object-contain" src="">
                        <div
                            class="slot-loader absolute inset-0 bg-slate-900/80 hidden flex-col items-center justify-center">
                            <div class="loader mb-2"></div>
                            <span class="text-xs font-bold text-blue-400 animate-pulse">AI Analyzing</span>
                        </div>
                        <div
                            class="slot-waiting absolute inset-0 bg-slate-900/60 hidden flex-col items-center justify-center backdrop-blur-sm">
                            <span class="bg-slate-600 text-white px-2 py-1 rounded text-xs font-bold">æ’éšŠä¸­</span>
                        </div>
                    </div>
                    <div
                        class="aspect-video bg-slate-800/50 rounded-xl overflow-hidden border border-slate-700 relative flex items-center justify-center">
                        <img class="result-img w-full h-full object-contain hidden" src="">
                        <div class="placeholder text-slate-600 italic font-bold text-xs">No Result</div>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button
                        class="process-btn bg-slate-700 hover:bg-slate-600 text-white text-xs py-2 rounded-lg flex-1 font-bold transition">å»æ–‡å­—</button>
                    <button
                        class="download-btn bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 rounded-lg font-bold disabled:opacity-30 transition"
                        disabled>ä¸‹è¼‰</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // ============================================
        // å…¨åŸŸè¨­å®š
        // ============================================
        // Global settings
        let apiKey = localStorage.getItem('gemini_api_key') || "";
        let apiTier = localStorage.getItem('gemini_api_tier') || "free"; // 'free' or 'paid'

        // ... (constants) ...

        // ... (pdfjs init) ...

        // ... (helper functions) ...

        // ... (checkApiKey) ...

        // Settings Modal Logic
        if ($('#settings-btn')) {
            $('#settings-btn').onclick = () => {
                $('#api-key-input').value = apiKey;
                // Set radio button
                const radio = $(`input[name="api_tier"][value="${apiTier}"]`);
                if (radio) radio.checked = true;

                $('#settings-modal').classList.remove('hidden');
                $('#settings-modal').classList.add('flex');
            };
        }

        if ($('#save-api-key-btn')) {
            $('#save-api-key-btn').onclick = () => {
                const inputKey = $('#api-key-input').value.trim();
                const selectedTier = $('input[name="api_tier"]:checked').value;

                if (inputKey) {
                    apiKey = inputKey;
                    apiTier = selectedTier;

                    localStorage.setItem('gemini_api_key', apiKey);
                    localStorage.setItem('gemini_api_tier', apiTier);

                    $('#settings-modal').classList.add('hidden');
                    $('#settings-modal').classList.remove('flex');
                    showToast(`è¨­å®šå·²å„²å­˜ (${apiTier === 'free' ? 'å…è²»ç‰ˆæ¨¡å¼' : 'ä»˜è²»ç‰ˆæ¨¡å¼'})`);
                } else {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key', true);
                }
            };
        }

        // ... (rest of settings logic) ...

        // å¢å¼·å‹é‡è©¦æ©Ÿåˆ¶ (No changes needed here, 429 handling is fallback)
        async function fetchWithRetry(url, options, maxRetries = 6) {
            // ... (existing content) ...
            if (!checkApiKey()) throw new Error("è«‹å…ˆè¨­å®š API Key");
            // ...
            // (Just keeping existing logic, essentially)
            const delays = [1000, 2000, 4000, 8000, 16000, 32000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    // ... (rest as before)
                    if (response.ok) return await response.json();

                    if (response.status === 400 && url.includes('key=')) {
                        throw new Error("API Key ç„¡æ•ˆæˆ–è«‹æ±‚æ ¼å¼éŒ¯èª¤");
                    }

                    if (response.status === 429) {
                        const waitTime = delays[i];
                        showToast(`é »ç‡é™åˆ¶ï¼Œç­‰å¾… ${waitTime / 1000} ç§’å¾Œé‡è©¦...`, true);
                        await wait(waitTime);
                        continue;
                    }
                    if (response.status >= 500) { await wait(2000); continue; }
                    const errorJson = await response.json();
                    throw new Error(errorJson.error?.message || `HTTP ${response.status}`);
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await wait(delays[i]);
                }
            }
        }


        // Settings Modal é‚è¼¯
        if ($('#settings-btn')) {
            $('#settings-btn').onclick = () => {
                $('#api-key-input').value = apiKey;
                $('#settings-modal').classList.remove('hidden');
                $('#settings-modal').classList.add('flex');
            };
        }

        if ($('#save-api-key-btn')) {
            $('#save-api-key-btn').onclick = () => {
                const inputKey = $('#api-key-input').value.trim();
                if (inputKey) {
                    apiKey = inputKey;
                    localStorage.setItem('gemini_api_key', apiKey);
                    $('#settings-modal').classList.add('hidden');
                    $('#settings-modal').classList.remove('flex');
                    showToast('API Key å·²å„²å­˜');
                } else {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key', true);
                }
            };
        }

        if ($('#close-settings-btn')) {
            $('#close-settings-btn').onclick = () => {
                $('#settings-modal').classList.add('hidden');
                $('#settings-modal').classList.remove('flex');
            };
        }

        // æ‹–æ”¾è¨­ç½®
        function setupDragAndDrop(element, onDropCallback) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                element.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            element.addEventListener('dragover', () => element.classList.add('active'));
            element.addEventListener('dragleave', () => element.classList.remove('active'));
            element.addEventListener('drop', (e) => {
                element.classList.remove('active');
                const files = e.dataTransfer.files;
                if (files && files.length > 0) onDropCallback(files);
            });
        }

        // ============================================
        // Tab åˆ‡æ›
        // ============================================
        $('#tab-pdf').onclick = () => switchTab('pdf');
        $('#tab-merge').onclick = () => switchTab('merge');

        function switchTab(tab) {
            $$('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-slate-400');
            });
            $(`#tab-${tab}`).classList.add('active');
            $(`#tab-${tab}`).classList.remove('text-slate-400');

            $$('.tool-section').forEach(sec => sec.classList.remove('active'));
            $(`#section-${tab}`).classList.add('active');
        }

        // ============================================
        // å·¥å…· 1: PDF è§£æ & å»å­—
        // ============================================
        let currentPdfPageUrls = [];
        let slots = [];

        // PDF ä¸Šå‚³
        setupDragAndDrop($('#pdf-drop-zone'), (files) => {
            const file = files[0];
            if (file.type === 'application/pdf') processPdf(file);
            else showToast('è«‹æ‹–æ”¾ PDF æª”æ¡ˆ', true);
        });

        $('#pdf-file-input').onchange = (e) => { if (e.target.files[0]) processPdf(e.target.files[0]); };
        $('#pdf-drop-zone').onclick = (e) => { if (!e.target.closest('#pdf-preview-container')) $('#pdf-file-input').click(); };

        async function processPdf(file) {
            showToast('æ­£åœ¨è§£æ PDF è¦–è¦ºä½ˆå±€...');
            currentPdfPageUrls = [];
            $('#pdf-preview-container').classList.remove('hidden');
            $('#pdf-pages-list').innerHTML = '';
            $('#pdf-empty-state').classList.add('hidden');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                $('#page-count-tag').textContent = `${pdf.numPages} PAGES`;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.5 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    const dataUrl = canvas.toDataURL('image/png');
                    currentPdfPageUrls.push(dataUrl);

                    const div = document.createElement('div');
                    div.className = 'page-card glass-card p-2 rounded-xl relative group cursor-pointer';
                    div.innerHTML = `
                <div class="relative overflow-hidden rounded-lg">
                    <img src="${dataUrl}" class="w-full">
                    <button class="add-btn absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white w-7 h-7 rounded-lg opacity-0 group-hover:opacity-100 transition shadow-xl font-black text-sm">ï¼‹</button>
                </div>
                <div class="text-xs font-bold text-center mt-2 text-slate-500">Page ${i}</div>
            `;
                    div.querySelector('.add-btn').onclick = (e) => { e.stopPropagation(); fillSlot(dataUrl); };
                    $('#pdf-pages-list').appendChild(div);
                }
                showToast(`æˆåŠŸè§£æ ${pdf.numPages} é `);
            } catch (err) {
                showToast('PDF è§£æå¤±æ•—: ' + err.message, true);
            }
        }

        $('#clear-pdf-btn').onclick = () => {
            $('#pdf-pages-list').innerHTML = '';
            currentPdfPageUrls = [];
            $('#pdf-preview-container').classList.add('hidden');
            $('#pdf-empty-state').classList.remove('hidden');
        };

        $('#add-all-pages-btn').onclick = () => currentPdfPageUrls.forEach(url => fillSlot(url));

        // PPTX è¦–è¦ºé‚„åŸ
        $('#pdf-to-pptx-btn').onclick = async () => {
            const btn = $('#pdf-to-pptx-btn');
            const txt = $('#pptx-btn-text');
            const ldr = $('#pptx-loader');
            btn.disabled = true;
            ldr.classList.remove('hidden');

            try {
                const pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_WIDE';

                for (let i = 0; i < currentPdfPageUrls.length; i++) {
                    txt.textContent = `è¾¨è­˜ä¸­ (${i + 1}/${currentPdfPageUrls.length})`;
                    const base64 = currentPdfPageUrls[i].split(',')[1];
                    const blocks = await callAiOcr(base64);
                    const slide = pptx.addSlide();
                    slide.background = { fill: "FFFFFF" };

                    if (blocks && Array.isArray(blocks) && blocks.length > 0) {
                        blocks.forEach(block => {
                            if (!block.text || !block.box_2d) return;
                            let [ymin, xmin, ymax, xmax] = block.box_2d;
                            if (ymax <= 1 && xmax <= 1) {
                                ymin *= 1000; xmin *= 1000; ymax *= 1000; xmax *= 1000;
                            }
                            const xP = xmin / 10, yP = ymin / 10;
                            const wP = (xmax - xmin) / 10, hP = (ymax - ymin) / 10;
                            slide.addText(block.text, {
                                x: `${xP.toFixed(2)}%`,
                                y: `${yP.toFixed(2)}%`,
                                w: `${wP.toFixed(2)}%`,
                                h: `${hP.toFixed(2)}%`,
                                fontSize: block.font_size || 12,
                                color: block.color?.replace('#', '') || '000000',
                                bold: block.is_bold || false,
                                align: block.align || 'left',
                                valign: 'middle',
                                margin: 0
                            });
                        });
                        showToast(`ç¬¬ ${i + 1} é è¾¨è­˜åˆ° ${blocks.length} å€‹æ–‡å­—å¡Š`);
                    } else {
                        showToast(`ç¬¬ ${i + 1} é æœªåµæ¸¬åˆ°æ˜é¡¯æ–‡å­—`, true);
                    }
                    await wait(1800);
                }

                pptx.writeFile({ fileName: `Restore_${Date.now()}.pptx` });
                showToast('PPTX é‡å»ºæˆåŠŸï¼');
            } catch (err) {
                console.error(err);
                showToast(`è¾¨è­˜å‡ºéŒ¯: ${err.message}`, true);
            } finally {
                btn.disabled = false;
                ldr.classList.add('hidden');
                txt.textContent = 'è¦–è¦ºé‚„åŸ PPTX';
            }
        };

        async function callAiOcr(base64) {
            const prompt = `è«‹è¾¨è­˜åœ–ç‰‡ä¸­ã€Œæ‰€æœ‰ã€æ–‡å­—å€å¡Šã€‚JSON æ ¼å¼åŒ…å«ï¼štext, box_2d[ymin, xmin, ymax, xmax], font_size, is_bold, align, colorã€‚åº§æ¨™æ¯”ä¾‹ 0-1000ã€‚`;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                text: { type: "STRING" },
                                box_2d: { type: "ARRAY", items: { type: "NUMBER" }, minItems: 4, maxItems: 4 },
                                font_size: { type: "NUMBER" },
                                is_bold: { type: "BOOLEAN" },
                                align: { type: "STRING" },
                                color: { type: "STRING" }
                            },
                            required: ["text", "box_2d"]
                        }
                    }
                }
            };
            const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_OCR}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
            return textResult ? JSON.parse(textResult) : [];
        }

        // æ§½ä½ç®¡ç†
        function initSlots(count) {
            $('#slots-container').innerHTML = '';
            slots = [];
            for (let i = 0; i < count; i++) addNewSlot();
            updateGlobalControls();
        }

        function addNewSlot() {
            const i = slots.length;
            const clone = $('#slot-template').content.cloneNode(true);
            const card = clone.querySelector('.slot-card');
            const data = {
                index: i,
                el: card,
                originalImg: card.querySelector('.original-img'),
                resultImg: card.querySelector('.result-img'),
                loader: card.querySelector('.slot-loader'),
                waitingOverlay: card.querySelector('.slot-waiting'),
                originalBase64: null
            };
            card.querySelector('.slot-label').textContent = `SLOT ${String(i + 1).padStart(2, '0')}`;
            // Remove button now removes the specific slot entirely if it's an extra one, or just clears it if it's one of the base ones?
            // User requested "don't only have 4", let's make it simple: "Clear" clears content. 
            // If we want to support "removing the row", that's more complex with grid. 
            // For now, let's stick to "Clear content" for consistency, but allow endless adding.
            card.querySelector('.remove-btn').onclick = () => resetSlot(i);
            card.querySelector('.process-btn').onclick = () => processSlot(i);

            slots.push(data);
            $('#slots-container').appendChild(card);
            return data;
        }

        function fillSlotWithData(i, item) {
            // Check if slot exists, if not create it (though initSlots should handle this if we used it correctly, but for safety)
            while (slots.length <= i) addNewSlot();

            const s = slots[i];
            s.originalBase64 = item.b64;
            s.originalImg.src = `data:image/png;base64,${item.b64}`;
            s.el.querySelector('.empty-state').classList.add('hidden');
            s.el.querySelector('.active-state').classList.remove('hidden');
            if (item.res && item.res.startsWith('data')) {
                s.resultImg.src = item.res;
                s.resultImg.classList.remove('hidden');
                s.el.querySelector('.placeholder').classList.add('hidden');
                s.el.querySelector('.download-btn').disabled = false;
            }
        }

        function fillSlot(url) {
            let slot = slots.find(s => !s.originalBase64);
            if (!slot) {
                // Auto-expand if no empty slot
                slot = addNewSlot();
            }

            slot.originalBase64 = url.split(',')[1];
            slot.originalImg.src = url;
            slot.el.querySelector('.empty-state').classList.add('hidden');
            slot.el.querySelector('.active-state').classList.remove('hidden');
            updateGlobalControls();
        }

        async function processSlot(i) {
            const s = slots[i];
            if (!s.originalBase64) return;
            s.loader.classList.remove('hidden');
            s.loader.style.display = 'flex';

            try {
                const prompt = "Please remove all text from this image. Fill the gaps using the surrounding background texture to make it look clean and natural.";
                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: s.originalBase64 } }] }],
                        generationConfig: { responseModalities: ['IMAGE'] }
                    })
                });
                const b64 = data.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                s.resultImg.src = `data:image/png;base64,${b64}`;
                s.resultImg.classList.remove('hidden');
                s.el.querySelector('.placeholder').classList.add('hidden');
                s.el.querySelector('.download-btn').disabled = false;
                s.el.querySelector('.download-btn').onclick = () => {
                    const a = document.createElement('a');
                    a.href = s.resultImg.src;
                    a.download = `cleaned_${s.index + 1}.png`;
                    a.click();
                };
                showToast(`Slot ${s.index + 1} è™•ç†å®Œæˆ`);
            } catch (e) {
                showToast(`è™•ç†å¤±æ•—: ${e.message}`, true);
            } finally {
                s.loader.classList.add('hidden');
                s.loader.style.display = 'none';
                updateGlobalControls();
            }
        }


        // Queue Processing
        $('#process-all-btn').onclick = async () => {
            const pending = slots.filter(s => s.originalBase64 && !s.resultImg.src.startsWith('data'));
            if (pending.length === 0) return;

            showToast(`ä½‡åˆ—å•Ÿå‹•ï¼šå…± ${pending.length} å¼µåœ–ç‰‡ (${apiTier === 'free' ? 'å…è²»æ¨¡å¼: æ…¢é€Ÿç©©å®š' : 'ä»˜è²»æ¨¡å¼: é«˜é€Ÿä½µç™¼'})`);

            // Set pending state
            pending.forEach(s => {
                s.waitingOverlay.classList.remove('hidden');
                s.waitingOverlay.style.display = 'flex';
            });

            if (apiTier === 'free') {
                // Free Tier: Strictly Sequential with Forced Delay (4s)
                for (const s of pending) {
                    const startTime = Date.now();
                    s.waitingOverlay.classList.add('hidden');
                    s.waitingOverlay.style.display = 'none';

                    await processSlot(s.index);

                    // Force minimum 4.2s interval to be safe for 15 RPM
                    const elapsed = Date.now() - startTime;
                    const remaining = 4200 - elapsed;
                    if (remaining > 0 && s !== pending[pending.length - 1]) {
                        await wait(remaining);
                    }
                }
            } else {
                // Paid Tier: Parallel Processing (Pool size 5)
                const poolSize = 5;
                const queue = [...pending];
                const active = [];

                while (queue.length > 0 || active.length > 0) {
                    while (queue.length > 0 && active.length < poolSize) {
                        const s = queue.shift();
                        s.waitingOverlay.classList.add('hidden');
                        s.waitingOverlay.style.display = 'none';
                        const p = processSlot(s.index).then(() => {
                            active.splice(active.indexOf(p), 1);
                        });
                        active.push(p);
                    }
                    if (active.length > 0) {
                        await Promise.race(active);
                    }
                }
            }

            showToast('æ‰¹æ¬¡è™•ç†å®Œæˆ');
        };


        $('#clear-all-slots-btn').onclick = () => {
            // Reset to default 4 slots
            initSlots(4);
            showToast('å·¥ä½œå°å·²å…¨éƒ¨æ¸…é™¤');
        };

        // Remove slot count listener since we auto-expand
        if ($('#slot-count-select')) $('#slot-count-select').style.display = 'none';

        $('#export-results-pptx-btn').onclick = () => {
            const results = slots.filter(s => s.resultImg.src.startsWith('data:image'));
            if (results.length === 0) return showToast('æ²’æœ‰å¯å°å‡ºçš„çµæœ', true);

            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_WIDE';
            results.forEach(s => pptx.addSlide().addImage({ data: s.resultImg.src, x: 0, y: 0, w: '100%', h: '100%' }));
            pptx.writeFile({ fileName: `Results_${Date.now()}.pptx` });
            showToast('çµæœå·²å°å‡º');
        };

        function resetSlot(i) {
            const s = slots[i];
            s.originalBase64 = null;
            s.resultImg.src = '';
            s.resultImg.classList.add('hidden');
            s.el.querySelector('.empty-state').classList.remove('hidden');
            s.el.querySelector('.active-state').classList.add('hidden');
            s.el.querySelector('.placeholder').classList.remove('hidden');
            updateGlobalControls();
        }

        function updateGlobalControls() {
            const hasProcessable = slots.some(s => s.originalBase64 && !s.resultImg.src.startsWith('data'));
            const hasResults = slots.some(s => s.resultImg.src.startsWith('data:image'));
            const hasAnyContent = slots.some(s => s.originalBase64);
            $('#process-all-btn').classList.toggle('hidden', !hasProcessable);
            $('#result-export-group').classList.toggle('hidden', !hasResults);
            $('#clear-all-slots-btn').classList.toggle('hidden', !hasAnyContent);
        }

        // åœ–ç‰‡ä¸Šå‚³
        setupDragAndDrop($('#master-drop-zone'), async (files) => {
            for (const file of Array.from(files)) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => fillSlot(ev.target.result);
                    reader.readAsDataURL(file);
                }
            }
        });
        $('#master-drop-zone').onclick = () => $('#master-file-input').click();
        $('#master-file-input').onchange = (e) => {
            Array.from(e.target.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => fillSlot(ev.target.result);
                    reader.readAsDataURL(file);
                }
            });
        };

        // ============================================
        // å·¥å…· 2: PPTX åˆä½µ
        // ============================================
        let mergeTextFile = null;
        let mergeBgFile = null;
        let mergeDownloadUrl = null;

        // æ–‡å­—æª”ä¸Šå‚³
        setupDragAndDrop($('#merge-text-zone'), (files) => {
            const file = files[0];
            if (file.name.endsWith('.pptx')) setMergeFile('text', file);
            else showToast('è«‹ä¸Šå‚³ .pptx æ ¼å¼', true);
        });
        $('#merge-text-zone').onclick = () => $('#merge-text-input').click();
        $('#merge-text-input').onchange = (e) => { if (e.target.files[0]) setMergeFile('text', e.target.files[0]); };

        // èƒŒæ™¯æª”ä¸Šå‚³
        setupDragAndDrop($('#merge-bg-zone'), (files) => {
            const file = files[0];
            if (file.name.endsWith('.pptx')) setMergeFile('bg', file);
            else showToast('è«‹ä¸Šå‚³ .pptx æ ¼å¼', true);
        });
        $('#merge-bg-zone').onclick = () => $('#merge-bg-input').click();
        $('#merge-bg-input').onchange = (e) => { if (e.target.files[0]) setMergeFile('bg', e.target.files[0]); };

        function setMergeFile(type, file) {
            if (type === 'text') {
                mergeTextFile = file;
                $('#merge-text-empty').classList.add('hidden');
                $('#merge-text-filled').classList.remove('hidden');
                $('#merge-text-name').textContent = file.name;
            } else {
                mergeBgFile = file;
                $('#merge-bg-empty').classList.add('hidden');
                $('#merge-bg-filled').classList.remove('hidden');
                $('#merge-bg-name').textContent = file.name;
            }
            $('#merge-start-btn').disabled = !(mergeTextFile && mergeBgFile);
        }

        function addMergeLog(msg) {
            const container = $('#merge-log-content');
            if (container.querySelector('.italic')) container.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'text-emerald-400';
            div.textContent = `> ${msg}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        $('#merge-start-btn').onclick = async () => {
            if (!mergeTextFile || !mergeBgFile) return;

            $('#merge-start-btn').classList.add('hidden');
            $('#merge-status').classList.remove('hidden');
            $('#merge-processing').classList.remove('hidden');
            $('#merge-success').classList.add('hidden');
            $('#merge-error').classList.add('hidden');
            $('#merge-log-content').innerHTML = '';

            addMergeLog('åˆå§‹åŒ–è™•ç†ç¨‹åº...');

            try {
                const textZip = new JSZip();
                const bgZip = new JSZip();

                addMergeLog('è®€å–: æ–‡å­—ä¾†æºæª”...');
                const textContent = await textZip.loadAsync(mergeTextFile);
                addMergeLog('è®€å–: èƒŒæ™¯åŸºåº•æª”...');
                const bgContent = await bgZip.loadAsync(mergeBgFile);

                const textSlides = Object.keys(textContent.files).filter(path => path.match(/ppt\/slides\/slide\d+\.xml/));
                const bgSlides = Object.keys(bgContent.files).filter(path => path.match(/ppt\/slides\/slide\d+\.xml/));

                const sorter = (a, b) => {
                    const getNum = (str) => { const match = str.match(/slide(\d+)\.xml/); return match ? parseInt(match[1]) : 0; };
                    return getNum(a) - getNum(b);
                };
                textSlides.sort(sorter);
                bgSlides.sort(sorter);

                addMergeLog(`åµæ¸¬: æ–‡å­—æª” ${textSlides.length} é , èƒŒæ™¯æª” ${bgSlides.length} é `);

                const processCount = Math.min(textSlides.length, bgSlides.length);
                const parser = new DOMParser();
                const serializer = new XMLSerializer();

                const getSpTree = (doc) => {
                    if (!doc) return null;
                    let tree = doc.getElementsByTagName("p:spTree")[0];
                    if (tree) return tree;
                    const all = doc.getElementsByTagName("*");
                    for (let i = 0; i < all.length; i++) {
                        if (all[i].localName === "spTree") return all[i];
                    }
                    return null;
                };

                for (let i = 0; i < processCount; i++) {
                    const textSlidePath = textSlides[i];
                    const bgSlidePath = bgSlides[i];

                    const textXmlStr = await textContent.file(textSlidePath).async("string");
                    const bgXmlStr = await bgContent.file(bgSlidePath).async("string");

                    const textDoc = parser.parseFromString(textXmlStr, "application/xml");
                    const bgDoc = parser.parseFromString(bgXmlStr, "application/xml");

                    if (textDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error(`è§£ææ–‡å­—æª” XML å¤±æ•—: ${textSlidePath}`);
                    }

                    const textSpTree = getSpTree(textDoc);
                    const bgSpTree = getSpTree(bgDoc);

                    if (textSpTree && bgSpTree) {
                        const textChildren = Array.from(textSpTree.childNodes);
                        let addedCount = 0;
                        textChildren.forEach(node => {
                            const localName = node.localName || (node.nodeName ? node.nodeName.split(':').pop() : '');
                            const allowedTags = ['sp', 'grpSp', 'graphicFrame', 'pic'];
                            if (allowedTags.includes(localName)) {
                                try {
                                    const clonedNode = bgDoc.importNode(node, true);
                                    const cNvPr = clonedNode.getElementsByTagName ?
                                        (clonedNode.getElementsByTagName("p:cNvPr")[0] || clonedNode.getElementsByTagName("cNvPr")[0]) : null;
                                    if (cNvPr && cNvPr.getAttribute("id")) {
                                        cNvPr.setAttribute("id", cNvPr.getAttribute("id") + "999");
                                    }
                                    bgSpTree.appendChild(clonedNode);
                                    addedCount++;
                                } catch (e) { console.warn("Node import failed", e); }
                            }
                        });
                        addMergeLog(`ç¬¬ ${i + 1} é : åˆä½µäº† ${addedCount} å€‹ç‰©ä»¶`);
                    } else {
                        addMergeLog(`ç¬¬ ${i + 1} é : æ‰¾ä¸åˆ°å…§å®¹çµæ§‹(spTree)ï¼Œè·³é`);
                    }

                    const newBgXmlStr = serializer.serializeToString(bgDoc);
                    bgContent.file(bgSlidePath, newBgXmlStr);
                }

                addMergeLog('æ­£åœ¨æ‰“åŒ…æ–°æª”æ¡ˆ...');
                const content = await bgContent.generateAsync({ type: "blob" });
                mergeDownloadUrl = URL.createObjectURL(content);

                $('#merge-processing').classList.add('hidden');
                $('#merge-success').classList.remove('hidden');
                addMergeLog('è™•ç†å®Œæˆï¼');

            } catch (err) {
                console.error(err);
                $('#merge-processing').classList.add('hidden');
                $('#merge-error').classList.remove('hidden');
                $('#merge-error').textContent = `éŒ¯èª¤: ${err.message}`;
                addMergeLog(`éŒ¯èª¤: ${err.message}`);
            }
        };

        $('#merge-download-btn').onclick = () => {
            if (mergeDownloadUrl) {
                const a = document.createElement('a');
                a.href = mergeDownloadUrl;
                a.download = "merged_presentation.pptx";
                a.click();
            }
        };

        $('#merge-reset-btn').onclick = () => {
            mergeTextFile = null;
            mergeBgFile = null;
            mergeDownloadUrl = null;

            $('#merge-text-empty').classList.remove('hidden');
            $('#merge-text-filled').classList.add('hidden');
            $('#merge-bg-empty').classList.remove('hidden');
            $('#merge-bg-filled').classList.add('hidden');

            $('#merge-start-btn').classList.remove('hidden');
            $('#merge-start-btn').disabled = true;
            $('#merge-status').classList.add('hidden');

            $('#merge-log-content').innerHTML = '<span class="text-slate-600 italic">ç­‰å¾…æ“ä½œ...</span>';
        };

        // åˆå§‹åŒ–
        initSlots(4);
    </script>
</body>

</html>